<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>AV評価アプリ</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: sans-serif; margin: 20px; }
button { margin: 4px; }
.card {
  border: 1px solid #ccc;
  padding: 10px;
  margin-bottom: 10px;
}
.score { display: flex; gap: 8px; }
.memo { margin-top: 6px; font-size: 0.9em; color: #444; }
</style>
</head>
<body>

<h1>AV評価アプリ</h1>

<button onclick="openCSV()">CSV入出力</button>

<select id="sortKey" onchange="render()">
  <option value="total">総合</option>
  <option value="visual">視界制圧力</option>
  <option value="mental">心理的引力</option>
  <option value="arousal">煽情恒常力</option>
</select>

<div id="list"></div>

<!-- CSV Window -->
<div id="csvWin" style="display:none;">
<textarea id="csvArea" rows="15" cols="80"></textarea><br>
<button onclick="importCSV()">読込</button>
<button onclick="exportCSV()">書出</button>
<button onclick="closeCSV()">閉じる</button>
</div>

<!-- Chart Window -->
<div id="chartWin" style="display:none;">
<canvas id="radar" width="300" height="300"></canvas><br>
<button onclick="closeChart()">閉じる</button>
</div>

<script>
const KEY = "av_app_data";
let data = load();
let chart = null;

function load(){
  try {
    return JSON.parse(localStorage.getItem(KEY)) || [];
  } catch {
    return [];
  }
}

function save(){
  localStorage.setItem(KEY, JSON.stringify(data));
}

function calc(d){
  const v =
    d.body*1.5 + d.nuki*1.3 + d.act*1.1 + d.face*0.7 + d.stable*0.3;
  const m =
    d.act*1.5 + d.nuki*1.3 + d.face*1.1 + d.body*0.7 + d.stable*0.3;
  const a =
    d.stable*1.5 + d.nuki*1.3 + d.act*1.1 + d.face*0.7 + d.body*0.3;
  return {visual:v, mental:m, arousal:a, total:v+m+a};
}

function render(){
  const key = sortKey.value;
  const list = document.getElementById("list");
  list.innerHTML = "";

  [...data]
    .map(d => ({...d, ...calc(d)}))
    .sort((a,b)=>b[key]-a[key])
    .forEach(d=>{
      const div = document.createElement("div");
      div.className="card";
      div.innerHTML = `
        <strong>${d.name}</strong>
        <div class="score">
          視界:${d.visual.toFixed(1)}
          心理:${d.mental.toFixed(1)}
          煽情:${d.arousal.toFixed(1)}
        </div>
        <div class="memo">${d.memo||""}</div>
        <button onclick="showChart('${d.name}')">レーダー</button>
      `;
      list.appendChild(div);
    });
}

function showChart(name){
  const d = data.find(x=>x.name===name);
  if(!d) return;

  document.getElementById("chartWin").style.display="block";
  const ctx = document.getElementById("radar").getContext("2d");

  if(chart) chart.destroy();

  chart = new Chart(ctx,{
    type:"radar",
    data:{
      labels:["顔","身体","演技","抜け度","安定感"],
      datasets:[{
        data:[d.face,d.body,d.act,d.nuki,d.stable],
        fill:true
      }]
    },
    options:{
      scales:{ r:{ min:0, max:100 } }
    }
  });
}

function closeChart(){
  document.getElementById("chartWin").style.display="none";
}

function openCSV(){
  document.getElementById("csvWin").style.display="block";
}

function closeCSV(){
  document.getElementById("csvWin").style.display="none";
}

function exportCSV(){
  const rows = [
    "名前,顔,身体,演技,抜け度,安定感,メモ",
    ...data.map(d=>[
      d.name,d.face,d.body,d.act,d.nuki,d.stable,
      `"${(d.memo||"").replace(/"/g,'""')}"`
    ].join(","))
  ];
  csvArea.value = rows.join("\n");
}

function importCSV(){
  const lines = csvArea.value.trim().split("\n").slice(1);
  const next = [];
  for(const l of lines){
    const m = l.match(/([^,]+),(\d+),(\d+),(\d+),(\d+),(\d+),"(.*)"/);
    if(!m) continue;
    next.push({
      name:m[1],
      face:+m[2],
      body:+m[3],
      act:+m[4],
      nuki:+m[5],
      stable:+m[6],
      memo:m[7]
    });
  }
  data = next;
  save();
  render();
}

render();
</script>
</body>
</html>
