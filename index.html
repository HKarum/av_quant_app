<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AV Quantification (完全版)</title>
<style>
  :root{--bg:#f7f7f9;--card:#fff;--accent:#0b66ff;--muted:#6b7280;--radius:12px;font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Yu Gothic","Noto Sans JP",Arial,sans-serif;color:#111;}
  html,body{height:100%;margin:0;background:var(--bg);} .wrap{max-width:920px;margin:16px auto;padding:16px;box-sizing:border-box;}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;}
  h1{font-size:18px;margin:0;}
  .card{background:var(--card);border-radius:var(--radius);padding:12px;box-shadow:0 1px 3px rgba(0,0,0,.06);margin-bottom:12px;}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px;}
  input[type="text"],input[type="number"],select{width:100%;padding:10px;font-size:15px;border-radius:8px;border:1px solid #e6e7ea;box-sizing:border-box;}
  .row{display:flex;gap:10px;flex-wrap:wrap;}
  .col{flex:1;min-width:120px;}
  .btn{display:inline-block;padding:8px 12px;border-radius:8px;background:var(--accent);color:white;border:none;font-size:14px;cursor:pointer;}
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid var(--accent);}
  table{width:100%;border-collapse:collapse;font-size:14px;}
  th,td{padding:8px;text-align:left;border-bottom:1px solid #eef0f2;}
  th{background:#fbfbfc;font-weight:600;}
  .actions button{background:transparent;border:none;font-size:18px;cursor:pointer;padding:6px;border-radius:6px;}
  .actions button.edit{color:#0b66ff;}
  .actions button.del{color:#e5533d;}
  .muted{color:var(--muted);font-size:13px;}
  @media (max-width:720px){ .row{flex-direction:column;} .col{min-width:unset;} table th:nth-child(2),table td:nth-child(2){display:none;} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>AV Quantification — 管理</h1>
    <div class="muted">データはブラウザ(localStorage)に保存されます</div>
  </header>

  <div class="card" id="formCard">
    <label for="name">名前</label>
    <input type="text" id="name" placeholder="女優名を入力">

    <div class="row" style="margin-top:8px;">
      <div class="col">
        <label for="body">身体 (1〜10)</label>
        <input type="number" id="body" min="1" max="10" placeholder="例: 8">
      </div>
      <div class="col">
        <label for="nuke">抜け度 (1〜10)</label>
        <input type="number" id="nuke" min="1" max="10" placeholder="例: 7">
      </div>
      <div class="col">
        <label for="acting">演技 (1〜10)</label>
        <input type="number" id="acting" min="1" max="10" placeholder="例: 6">
      </div>
      <div class="col">
        <label for="face">顔 (1〜10)</label>
        <input type="number" id="face" min="1" max="10" placeholder="例: 9">
      </div>
    </div>

    <div style="margin-top:8px;">
      <label for="rep">代表作点数（整数）</label>
      <input type="number" id="rep" min="0" placeholder="例: 20">
    </div>

    <div style="display:flex;gap:8px;margin-top:12px;">
      <button class="btn" id="saveBtn">登録</button>
      <button class="btn ghost" id="clearBtn" type="button">クリア</button>
      <button class="btn ghost" id="exportBtn" type="button">エクスポート (CSV)</button>
      <button class="btn ghost" id="importBtn" type="button">インポート (CSV)</button>
      <input type="file" id="csvFile" accept=".csv" style="display:none">
    </div>
    <div id="formError" class="muted" style="margin-top:8px;color:#e5533d;display:none;"></div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px 0;">ランキング</h3>
    <table>
      <thead>
        <tr>
          <th>名前</th>
          <th>順位</th>
          <th>視界制圧力</th>
          <th>心理的引力</th>
          <th>代表作点数</th>
          <th style="width:120px">操作</th>
        </tr>
      </thead>
      <tbody id="ranking"></tbody>
    </table>
  </div>
</div>

<script>
/* 計算式（仕様どおり） */
function calcShikai(body, nuke, acting, face){
  return Math.floor(((body * 0.8) + (nuke * 0.6) + (acting * 0.4) + (face * 0.2)) * 5);
}
function calcShinri(acting, face, nuke, body){
  return Math.floor(((acting * 0.8) + (face * 0.6) + (nuke * 0.4) + (body * 0.2)) * 5);
}

/* localStorage キー */
const STORAGE_KEY = 'avdata';

/* DOM */
const nameEl = document.getElementById('name');
const bodyEl = document.getElementById('body');
const nukeEl = document.getElementById('nuke');
const actingEl = document.getElementById('acting');
const faceEl = document.getElementById('face');
const repEl = document.getElementById('rep');
const saveBtn = document.getElementById('saveBtn');
const clearBtn = document.getElementById('clearBtn');
const rankingTbody = document.getElementById('ranking');
const formError = document.getElementById('formError');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const csvFile = document.getElementById('csvFile');

let dataset = []; // {id,name,body,nuke,acting,face,rep,shikai,shinri,total,createdAt,updatedAt}
let editingId = null;

/* ユーティリティ */
const uid = ()=> Date.now().toString(36) + Math.random().toString(36).slice(2,8);
const clampInt = (v, min, max) => {
  const n = Math.floor(Number(v) || 0);
  if(n < min) return min;
  if(n > max) return max;
  return n;
};

function loadData(){
  try{
    dataset = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  }catch(e){
    dataset = [];
  }
}
function saveData(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(dataset));
}

/* レンダリング（total 降順でソート） */
function render(){
  dataset.sort((a,b)=> b.total - a.total);
  rankingTbody.innerHTML = '';
  dataset.forEach((it, idx) => {
    const tr = document.createElement('tr');

    const tdName = document.createElement('td'); tdName.textContent = it.name;
    const tdRank = document.createElement('td'); tdRank.textContent = idx + 1;
    const tdShikai = document.createElement('td'); tdShikai.textContent = it.shikai;
    const tdShinri = document.createElement('td'); tdShinri.textContent = it.shinri;
    const tdRep = document.createElement('td'); tdRep.textContent = it.rep;

    const tdOps = document.createElement('td');
    tdOps.className = 'actions';

    // 編集ボタン（✎）
    const btnEdit = document.createElement('button');
    btnEdit.className = 'edit';
    btnEdit.title = '編集';
    btnEdit.innerHTML = '✎';
    btnEdit.addEventListener('click', ()=> beginEdit(it.id));

    // 削除ボタン（✕） -- 即削除（確認なし）
    const btnDel = document.createElement('button');
    btnDel.className = 'del';
    btnDel.title = '削除';
    btnDel.innerHTML = '✕';
    btnDel.addEventListener('click', ()=> {
      dataset = dataset.filter(d => d.id !== it.id);
      saveData();
      render();
    });

    tdOps.appendChild(btnEdit);
    tdOps.appendChild(btnDel);

    tr.appendChild(tdName);
    tr.appendChild(tdRank);
    tr.appendChild(tdShikai);
    tr.appendChild(tdShinri);
    tr.appendChild(tdRep);
    tr.appendChild(tdOps);

    rankingTbody.appendChild(tr);
  });
}

/* フォーム制御 */
function resetForm(){
  editingId = null;
  nameEl.value = '';
  bodyEl.value = '';
  nukeEl.value = '';
  actingEl.value = '';
  faceEl.value = '';
  repEl.value = '';
  saveBtn.textContent = '登録';
  formError.style.display = 'none';
}
function beginEdit(id){
  const it = dataset.find(d => d.id === id);
  if(!it) return;
  editingId = id;
  nameEl.value = it.name;
  bodyEl.value = it.body;
  nukeEl.value = it.nuke;
  actingEl.value = it.acting;
  faceEl.value = it.face;
  repEl.value = it.rep;
  saveBtn.textContent = '更新';
  window.scrollTo({top:0, behavior:'smooth'});
}

/* バリデーション & 保存処理 */
function validateForm(){
  const name = nameEl.value.trim();
  if(!name) return '名前を入力してください。';
  // 各スコアは 1-10 の整数（代表作は0以上）
  const b = Number(bodyEl.value);
  const n = Number(nukeEl.value);
  const a = Number(actingEl.value);
  const f = Number(faceEl.value);
  if(!Number.isFinite(b) || !Number.isFinite(n) || !Number.isFinite(a) || !Number.isFinite(f)) return '身体・抜け度・演技・顔は数値で入力してください。';
  if(b < 1 || b > 10 || n < 1 || n > 10 || a < 1 || a > 10 || f < 1 || f > 10) return '身体・抜け度・演技・顔は 1〜10 の範囲で入力してください。';
  if(!Number.isFinite(Number(repEl.value))) return '代表作点数は整数で入力してください。';
  return null;
}

saveBtn.addEventListener('click', ()=>{
  formError.style.display = 'none';
  const err = validateForm();
  if(err){
    formError.textContent = err;
    formError.style.display = 'block';
    return;
  }
  const name = nameEl.value.trim();
  const body = clampInt(bodyEl.value,1,10);
  const nuke = clampInt(nukeEl.value,1,10);
  const acting = clampInt(actingEl.value,1,10);
  const face = clampInt(faceEl.value,1,10);
  const rep = Math.floor(Number(repEl.value) || 0);

  const shikai = calcShikai(body, nuke, acting, face);
  const shinri = calcShinri(acting, face, nuke, body);
  const total = shikai + shinri + rep;

  if(editingId){
    const idx = dataset.findIndex(d => d.id === editingId);
    if(idx !== -1){
      dataset[idx] = {
        ...dataset[idx],
        name, body, nuke, acting, face, rep, shikai, shinri, total,
        updatedAt: (new Date()).toISOString()
      };
    }
  } else {
    dataset.push({
      id: uid(),
      name, body, nuke, acting, face, rep, shikai, shinri, total,
      createdAt: (new Date()).toISOString()
    });
  }

  saveData();
  render();
  resetForm();
});

/* クリア */
clearBtn.addEventListener('click', ()=> resetForm());

/* CSV エクスポート（簡易）*/
exportBtn.addEventListener('click', ()=>{
  if(dataset.length === 0){ alert('エクスポートするデータがありません。'); return; }
  const header = ['id','name','body','nuke','acting','face','rep','shikai','shinri','total','createdAt','updatedAt'];
  const lines = [header.join(',')];
  dataset.forEach(d=>{
    const row = header.map(h => {
      const v = d[h] ?? '';
      if(typeof v === 'string' && (v.includes(',') || v.includes('\n') || v.includes('"'))) return `"${v.replace(/"/g,'""')}"`;
      return v;
    });
    lines.push(row.join(','));
  });
  const csv = lines.join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'avdata.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

/* CSV インポート（簡易）*/
importBtn.addEventListener('click', ()=> csvFile.click());
csvFile.addEventListener('change', (ev)=>{
  const f = ev.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const txt = reader.result;
      const lines = txt.split(/\r?\n/).filter(l=> l.trim() !== '');
      if(lines.length < 2){ alert('CSVにデータが含まれていません。'); csvFile.value = ''; return; }
      const hdr = lines[0].split(',').map(h=> h.replace(/^"|"$/g,'').trim());
      const rows = lines.slice(1).map(line=>{
        const parts = []; let cur = ''; let inQ = false;
        for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch==='"'){ if(inQ && line[i+1]==='"'){ cur+='"'; i++; continue; } inQ=!inQ; continue; } if(ch===',' && !inQ){ parts.push(cur); cur=''; continue; } cur+=ch; }
        parts.push(cur);
        const obj = {}; hdr.forEach((h,idx)=> obj[h]= (parts[idx] ?? '').trim());
        return obj;
      });
      let count=0;
      rows.forEach(r=>{
        if(!r.name) return;
        const body = clampInt(Number(r.body)||1,1,10);
        const nuke = clampInt(Number(r.nuke)||1,1,10);
        const acting = clampInt(Number(r.acting)||1,1,10);
        const face = clampInt(Number(r.face)||1,1,10);
        const rep = Math.floor(Number(r.rep)||0);
        const shikai = calcShikai(body,nuke,acting,face);
        const shinri = calcShinri(acting,face,nuke,body);
        const total = shikai + shinri + rep;
        dataset.push({ id: r.id || uid(), name: r.name, body, nuke, acting, face, rep, shikai, shinri, total, createdAt: r.createdAt || (new Date()).toISOString() });
        count++;
      });
      saveData(); render(); alert(count+' 件をインポートしました。');
    }catch(e){
      alert('CSV の読み込みに失敗しました。');
    }
    csvFile.value = '';
  };
  reader.readAsText(f,'utf-8');
});

/* 初期化 */
(function init(){
  loadData();
  render();
})();
</script>
</body>
</html>
