<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>av_quant</title>
<style>
  :root{
    --bg:#f7f7f9;
    --card:#fff;
    --accent:#0b66ff;
    --danger:#e5533d;
    --muted:#6b7280;
    --radius:12px;
    font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Yu Gothic","Noto Sans JP",Arial,sans-serif;
    color:#111;
  }
  html,body{height:100%;margin:0;background:var(--bg);}
  .wrap{max-width:960px;margin:16px auto;padding:16px;box-sizing:border-box;}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
  h1{font-size:18px;margin:0;}
  .card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 1px 3px rgba(0,0,0,.06);margin-bottom:12px;}
  .topmenu{display:flex;gap:8px;flex-wrap:wrap;}
  .btn{display:inline-block;padding:8px 12px;border-radius:8px;background:var(--accent);color:#fff;border:none;font-size:14px;cursor:pointer;}
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid var(--accent);}
  .btn.danger{background:var(--danger);color:#fff;border:none;}
  .muted{color:var(--muted);font-size:13px;}
  .screen{display:none;}
  .screen.active{display:block;}
  .form-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px;}
  .form-row .label-col{width:110px;font-size:13px;color:var(--muted);}
  .scores{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
  .score-col{display:flex;flex-direction:column;align-items:center;min-width:64px}
  .score-col label{font-size:13px;color:var(--muted);margin-bottom:6px;}
  input[type="number"], input[type="text"], select{padding:8px;border-radius:8px;border:1px solid #e6e7ea;font-size:14px;box-sizing:border-box;}
  input[type="number"]{width:72px;text-align:center;}
  input[type="text"]{width:100%;}
  table{width:100%;border-collapse:collapse;font-size:14px;margin-top:8px;}
  th,td{padding:8px;border-bottom:1px solid #eef0f2;text-align:left;}
  th{background:#fbfbfc;font-weight:600;}
  td.name-col{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:6ch;}
  .actions button{background:transparent;border:none;font-size:18px;cursor:pointer;padding:6px;border-radius:6px;}
  .actions button.edit{color:var(--accent);}
  .actions button.del{color:var(--danger);}
  .top-return{margin-top:12px;}
  .flex-between{display:flex;justify-content:space-between;align-items:center;gap:8px;}
  .select-sort{padding:8px;border-radius:8px;border:1px solid #e6e7ea;}
  .hidden{display:none;}
  @media (max-width:720px){
    .form-row{flex-direction:column;align-items:flex-start;}
    .form-row .label-col{width:auto;}
    .scores{gap:6px;}
  }
</style>
</head>
<body>
<div class="wrap">

  <header>
    <h1>av_quant</h1>
    <div class="muted">データはブラウザ(localStorage)に保存。CSVでバックアップできます。</div>
  </header>

  <!-- トップメニュー -->
  <div class="card">
    <div class="topmenu">
      <button class="btn" data-screen="ranking">ランキング表示</button>
      <button class="btn" data-screen="add">女優追加</button>
      <button class="btn" data-screen="edit">女優編集</button>
      <button class="btn" id="csvImportBtn">CSV読み込み</button>
      <button class="btn" id="csvExportBtn">CSV出力</button>
      <input type="file" id="csvFile" accept=".csv" style="display:none">
    </div>
  </div>

  <!-- ランキング画面 -->
  <section id="ranking" class="card screen" aria-label="ランキング画面">
    <div class="flex-between">
      <h2 style="margin:0">ランキング</h2>
      <div>
        <label class="muted" for="sortSelect">並び替え：</label>
        <select id="sortSelect" class="select-sort" aria-label="並び替え">
          <option value="total_desc">total</option>
          <option value="shikai_desc">視界制圧力</option>
          <option value="shinri_desc">心理的引力</option>
          <option value="rep_desc">代表作点数</option>
          <option value="face_desc">顔</option>
          <option value="body_desc">身体</option>
          <option value="acting_desc">演技</option>
          <option value="nuke_desc">抜け度</option>
          <option value="name_asc">名前（昇順）</option>
        </select>
      </div>
    </div>

    <table aria-label="ランキング表">
      <thead>
        <tr>
          <th>名前</th>
          <th>順位</th>
          <th>視界制圧力</th>
          <th>心理的引力</th>
          <th>代表作点数</th>
          <th style="width:120px">操作</th>
        </tr>
      </thead>
      <tbody id="rankingBody"></tbody>
    </table>

    <div class="top-return">
      <button class="btn ghost" data-screen="top">トップメニューに戻る</button>
    </div>
  </section>

  <!-- 女優追加画面 -->
  <section id="add" class="card screen" aria-label="女優追加画面">
    <h2 style="margin:0 0 8px 0">女優追加</h2>

    <div class="form-row">
      <div class="label-col">名前</div>
      <div style="flex:1"><input type="text" id="add_name" placeholder="女優名を入力" value=""></div>
    </div>

    <div class="form-row">
      <div class="label-col">顔 / 身体 / 演技 / 抜け度</div>
      <div class="scores">
        <div class="score-col"><label>顔</label><input type="number" id="add_face" min="1" max="10" value=""></div>
        <div class="score-col"><label>身体</label><input type="number" id="add_body" min="1" max="10" value=""></div>
        <div class="score-col"><label>演技</label><input type="number" id="add_acting" min="1" max="10" value=""></div>
        <div class="score-col"><label>抜け度</label><input type="number" id="add_nuke" min="1" max="10" value=""></div>
      </div>
    </div>

    <div class="form-row" style="margin-top:8px;">
      <div class="label-col">代表作点数</div>
      <div style="flex:1"><input type="number" id="add_rep" min="0" value=""></div>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;">
      <button class="btn" id="addSubmit">追加</button>
      <button class="btn ghost" data-screen="top">トップメニュー</button>
    </div>

    <div id="addError" class="muted" style="margin-top:8px;color:#e5533d;display:none;"></div>
  </section>

  <!-- 女優編集画面 -->
  <section id="edit" class="card screen" aria-label="女優編集画面">
    <h2 style="margin:0 0 8px 0">女優編集</h2>

    <div class="form-row">
      <div class="label-col">編集対象</div>
      <div style="flex:1">
        <select id="edit_select" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6e7ea;"></select>
      </div>
    </div>

    <div id="editArea" style="margin-top:12px;display:none;">
      <div class="form-row">
        <div class="label-col">名前</div>
        <div style="flex:1"><input type="text" id="edit_name" value=""></div>
      </div>

      <div class="form-row">
        <div class="label-col">顔 / 身体 / 演技 / 抜け度</div>
        <div class="scores">
          <div class="score-col"><label>顔</label><input type="number" id="edit_face" min="1" max="10" value=""></div>
          <div class="score-col"><label>身体</label><input type="number" id="edit_body" min="1" max="10" value=""></div>
          <div class="score-col"><label>演技</label><input type="number" id="edit_acting" min="1" max="10" value=""></div>
          <div class="score-col"><label>抜け度</label><input type="number" id="edit_nuke" min="1" max="10" value=""></div>
        </div>
      </div>

      <div class="form-row" style="margin-top:8px;">
        <div class="label-col">代表作点数</div>
        <div style="flex:1"><input type="number" id="edit_rep" min="0" value=""></div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;">
        <button class="btn" id="editSave">更新</button>
        <button class="btn danger" id="editDelete">削除</button>
        <button class="btn ghost" data-screen="top">トップメニュー</button>
      </div>
      <div id="editError" class="muted" style="margin-top:8px;color:#e5533d;display:none;"></div>
    </div>

    <div id="noActors" class="muted" style="display:none;margin-top:8px;">
      女優情報がありません。<button class="btn ghost" data-screen="top" style="margin-left:8px;">トップメニューへ</button>
    </div>
  </section>

</div>

<script>
/* Persistent key */
const STORAGE_KEY = 'avdata_v3';

/* Utilities */
const uid = ()=> Date.now().toString(36) + Math.random().toString(36).slice(2,8);
function loadData(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }catch(e){ return []; } }
function saveData(data){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
function clampInt(v, min, max){ const n = Math.floor(Number(v) || 0); if(n < min) return min; if(n > max) return max; return n; }

/* Calculation (spec) */
function calcShikai(body, nuke, acting, face){
  return Math.floor(((body * 0.8) + (nuke * 0.6) + (acting * 0.4) + (face * 0.2)) * 5);
}
function calcShinri(acting, face, nuke, body){
  return Math.floor(((acting * 0.8) + (face * 0.6) + (nuke * 0.4) + (body * 0.2)) * 5);
}

/* Screen control */
const screenElems = {
  top: null,
  ranking: document.getElementById('ranking'),
  add: document.getElementById('add'),
  edit: document.getElementById('edit')
};
document.querySelectorAll('[data-screen]').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    const target = btn.getAttribute('data-screen');
    if(target === 'top') showTop();
    else showScreen(target);
  });
});
document.querySelectorAll('.topmenu button').forEach(b=>{
  // csv buttons handled separately
  if(b.id === 'csvImportBtn' || b.id === 'csvExportBtn') return;
  b.addEventListener('click', ()=> {
    const sc = b.getAttribute('data-screen');
    if(sc) showScreen(sc);
  });
});

function hideAll(){ document.querySelectorAll('.screen').forEach(s=> s.classList.remove('active')); }
function showScreen(name){
  hideAll();
  const el = screenElems[name];
  if(el) el.classList.add('active');
  if(name === 'ranking') renderRanking();
  if(name === 'edit') prepareEdit();
  window.scrollTo({top:0,behavior:'smooth'});
}
function showTop(){ hideAll(); window.scrollTo({top:0,behavior:'smooth'}); }

/* Ranking rendering & sorting */
const rankingBody = document.getElementById('rankingBody');
const sortSelect = document.getElementById('sortSelect');

function sortData(data, mode){
  const arr = data.slice();
  switch(mode){
    case 'total_desc': arr.sort((a,b)=> (b.shikai + b.shinri + b.rep) - (a.shikai + a.shinri + a.rep)); break;
    case 'shikai_desc': arr.sort((a,b)=> b.shikai - a.shikai); break;
    case 'shinri_desc': arr.sort((a,b)=> b.shinri - a.shinri); break;
    case 'rep_desc': arr.sort((a,b)=> b.rep - a.rep); break;
    case 'face_desc': arr.sort((a,b)=> b.face - a.face); break;
    case 'body_desc': arr.sort((a,b)=> b.body - a.body); break;
    case 'acting_desc': arr.sort((a,b)=> b.acting - a.acting); break;
    case 'nuke_desc': arr.sort((a,b)=> b.nuke - a.nuke); break;
    case 'name_asc': arr.sort((a,b)=> a.name.localeCompare(b.name)); break;
    default: arr.sort((a,b)=> (b.shikai + b.shinri + b.rep) - (a.shikai + a.shinri + a.rep));
  }
  return arr;
}

function renderRanking(){
  const data = loadData();
  const mode = sortSelect.value;
  const list = sortData(data, mode);

  rankingBody.innerHTML = '';
  list.forEach((it, idx) => {
    const tr = document.createElement('tr');

    const tdName = document.createElement('td'); tdName.className = 'name-col'; tdName.textContent = it.name;
    const tdRank = document.createElement('td'); tdRank.textContent = idx + 1;
    const tdShikai = document.createElement('td'); tdShikai.textContent = it.shikai;
    const tdShinri = document.createElement('td'); tdShinri.textContent = it.shinri;
    const tdRep = document.createElement('td'); tdRep.textContent = it.rep;

    const tdOps = document.createElement('td'); tdOps.className = 'actions';
    const btnEdit = document.createElement('button'); btnEdit.className = 'edit'; btnEdit.title = '編集'; btnEdit.innerHTML = '✎';
    const btnDel = document.createElement('button'); btnDel.className = 'del'; btnDel.title = '削除'; btnDel.innerHTML = '✕';

    btnEdit.addEventListener('click', ()=> {
      showScreen('edit');
      // wait for select population
      setTimeout(()=> {
        const sel = document.getElementById('edit_select');
        sel.value = it.id;
        sel.dispatchEvent(new Event('change'));
      }, 150);
    });

    btnDel.addEventListener('click', ()=> {
      // immediate delete (no confirm)
      const all = loadData().filter(d => d.id !== it.id);
      saveData(all);
      renderRanking();
    });

    tdOps.appendChild(btnEdit);
    tdOps.appendChild(btnDel);

    tr.appendChild(tdName);
    tr.appendChild(tdRank);
    tr.appendChild(tdShikai);
    tr.appendChild(tdShinri);
    tr.appendChild(tdRep);
    tr.appendChild(tdOps);

    rankingBody.appendChild(tr);
  });
}
sortSelect.addEventListener('change', ()=> renderRanking());

/* Add screen logic */
const add_name = document.getElementById('add_name');
const add_face = document.getElementById('add_face');
const add_body = document.getElementById('add_body');
const add_acting = document.getElementById('add_acting');
const add_nuke = document.getElementById('add_nuke');
const add_rep = document.getElementById('add_rep');
const addSubmit = document.getElementById('addSubmit');
const addError = document.getElementById('addError');

function validateAdd(){
  const name = add_name.value.trim();
  if(!name) return '名前を入力してください。';
  const face = Number(add_face.value), body = Number(add_body.value), acting = Number(add_acting.value), nuke = Number(add_nuke.value);
  if(!Number.isFinite(face) || !Number.isFinite(body) || !Number.isFinite(acting) || !Number.isFinite(nuke)) return '顔・身体・演技・抜け度は数値で入力してください。';
  if(face <1 || face >10 || body <1 || body >10 || acting <1 || acting >10 || nuke <1 || nuke >10) return '顔・身体・演技・抜け度は 1〜10 の範囲で入力してください。';
  if(!Number.isFinite(Number(add_rep.value))) return '代表作点数は整数で入力してください。';
  return null;
}

addSubmit.addEventListener('click', ()=>{
  addError.style.display = 'none';
  const err = validateAdd();
  if(err){ addError.textContent = err; addError.style.display = 'block'; return; }

  const name = add_name.value.trim();
  const face = clampInt(add_face.value,1,10);
  const body = clampInt(add_body.value,1,10);
  const acting = clampInt(add_acting.value,1,10);
  const nuke = clampInt(add_nuke.value,1,10);
  const rep = Math.floor(Number(add_rep.value) || 0);

  const shikai = calcShikai(body, nuke, acting, face);
  const shinri = calcShinri(acting, face, nuke, body);
  const total = shikai + shinri + rep;

  const data = loadData();
  data.push({
    id: uid(),
    name, face, body, acting, nuke, rep, shikai, shinri, total,
    createdAt: new Date().toISOString()
  });
  saveData(data);

  // reset form -> empty
  add_name.value = '';
  add_face.value = '';
  add_body.value = '';
  add_acting.value = '';
  add_nuke.value = '';
  add_rep.value = '';

  showScreen('ranking');
  renderRanking();
});

/* Edit screen logic */
const edit_select = document.getElementById('edit_select');
const editArea = document.getElementById('editArea');
const noActors = document.getElementById('noActors');
const edit_name = document.getElementById('edit_name');
const edit_face = document.getElementById('edit_face');
const edit_body = document.getElementById('edit_body');
const edit_acting = document.getElementById('edit_acting');
const edit_nuke = document.getElementById('edit_nuke');
const edit_rep = document.getElementById('edit_rep');
const editSave = document.getElementById('editSave');
const editDelete = document.getElementById('editDelete');
const editError = document.getElementById('editError');

function prepareEdit(){
  const data = loadData();
  if(data.length === 0){
    edit_select.innerHTML = '';
    editArea.style.display = 'none';
    noActors.style.display = 'block';
    return;
  }
  noActors.style.display = 'none';
  editArea.style.display = 'block';
  edit_select.innerHTML = '';
  data.forEach(d=>{
    const opt = document.createElement('option');
    opt.value = d.id;
    opt.textContent = d.name;
    edit_select.appendChild(opt);
  });
  edit_select.value = data[0].id;
  fillEditFields(data[0]);
}

function fillEditFields(item){
  edit_name.value = item.name || '';
  edit_face.value = item.face || '';
  edit_body.value = item.body || '';
  edit_acting.value = item.acting || '';
  edit_nuke.value = item.nuke || '';
  edit_rep.value = item.rep || '';
  editError.style.display = 'none';
}

edit_select.addEventListener('change', ()=>{
  const id = edit_select.value;
  const data = loadData();
  const it = data.find(d=> d.id === id);
  if(it) fillEditFields(it);
});

function validateEdit(){
  const name = edit_name.value.trim();
  if(!name) return '名前を入力してください。';
  const face = Number(edit_face.value), body = Number(edit_body.value), acting = Number(edit_acting.value), nuke = Number(edit_nuke.value);
  if(!Number.isFinite(face) || !Number.isFinite(body) || !Number.isFinite(acting) || !Number.isFinite(nuke)) return '顔・身体・演技・抜け度は数値で入力してください。';
  if(face <1 || face >10 || body <1 || body >10 || acting <1 || acting >10 || nuke <1 || nuke >10) return '顔・身体・演技・抜け度は 1〜10 の範囲で入力してください。';
  if(!Number.isFinite(Number(edit_rep.value))) return '代表作点数は整数で入力してください。';
  return null;
}

editSave.addEventListener('click', ()=>{
  editError.style.display = 'none';
  const err = validateEdit();
  if(err){ editError.textContent = err; editError.style.display = 'block'; return; }

  const id = edit_select.value;
  const data = loadData();
  const idx = data.findIndex(d=> d.id === id);
  if(idx === -1) { editError.textContent = '選択されたデータが見つかりません。'; editError.style.display = 'block'; return; }

  const name = edit_name.value.trim();
  const face = clampInt(edit_face.value,1,10);
  const body = clampInt(edit_body.value,1,10);
  const acting = clampInt(edit_acting.value,1,10);
  const nuke = clampInt(edit_nuke.value,1,10);
  const rep = Math.floor(Number(edit_rep.value) || 0);

  const shikai = calcShikai(body, nuke, acting, face);
  const shinri = calcShinri(acting, face, nuke, body);
  const total = shikai + shinri + rep;

  data[idx] = {
    ...data[idx],
    name, face, body, acting, nuke, rep, shikai, shinri, total,
    updatedAt: new Date().toISOString()
  };
  saveData(data);
  prepareEdit();
  showScreen('ranking');
  renderRanking();
});

editDelete.addEventListener('click', ()=>{
  const id = edit_select.value;
  const data = loadData();
  const idx = data.findIndex(d=> d.id === id);
  if(idx === -1) return;
  data.splice(idx,1);
  saveData(data);
  prepareEdit();
  renderRanking();
});

/* CSV import/export
   - Import replaces existing data (A)
   - CSV format: header (optional) then rows: 名前,顔,身体,演技,抜け度,代表作点数
*/
const csvImportBtn = document.getElementById('csvImportBtn');
const csvExportBtn = document.getElementById('csvExportBtn');
const csvFile = document.getElementById('csvFile');

csvImportBtn.addEventListener('click', ()=> csvFile.click());
csvFile.addEventListener('change', (ev)=>{
  const f = ev.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=> {
    const txt = reader.result.replace(/\r/g,'');
    const lines = txt.split('\n').map(l=> l.trim()).filter(l=> l.length > 0);
    if(lines.length === 0){ alert('CSVにデータが含まれていません。'); csvFile.value = ''; return; }

    // If first line contains non-numeric in 2nd column -> treat as header and skip
    let start = 0;
    const firstCols = lines[0].split(',').map(s=>s.trim());
    if(firstCols.length > 1 && isNaN(Number(firstCols[1]))) start = 1;

    const rows = [];
    for(let i = start; i < lines.length; i++){
      const cols = lines[i].split(',').map(c=> c.trim());
      const name = cols[0] || '';
      if(!name) continue;
      const face = clampInt(cols[1],1,10);
      const body = clampInt(cols[2],1,10);
      const acting = clampInt(cols[3],1,10);
      const nuke = clampInt(cols[4],1,10);
      const rep = Math.floor(Number(cols[5]) || 0);
      const shikai = calcShikai(body, nuke, acting, face);
      const shinri = calcShinri(acting, face, nuke, body);
      const total = shikai + shinri + rep;
      rows.push({ id: uid(), name, face, body, acting, nuke, rep, shikai, shinri, total, createdAt: new Date().toISOString() });
    }

    // Replace existing data (A)
    saveData(rows);
    csvFile.value = '';
    showScreen('ranking');
    renderRanking();
    alert(rows.length + ' 件をインポートしました（既存データを上書き）。');
  };
  reader.readAsText(f, 'UTF-8');
});

csvExportBtn.addEventListener('click', ()=>{
  const data = loadData();
  if(data.length === 0){ alert('出力するデータがありません。'); return; }
  const header = ['名前','顔','身体','演技','抜け度','代表作点数'];
  const lines = [header.join(',')];
  data.forEach(d=>{
    lines.push([d.name,d.face,d.body,d.acting,d.nuke,d.rep].join(','));
  });
  const csv = lines.join('\r\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'avdata.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

/* Init */
(function init(){
  hideAll();
  renderRanking();
})();
</script>
</body>
</html>
