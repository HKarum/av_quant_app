<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>AV Actress Rating</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  font-family: sans-serif;
  margin: 20px;
}
input, textarea, select, button {
  margin: 4px;
}
.card {
  border: 1px solid #ccc;
  padding: 10px;
  margin-bottom: 10px;
}
.card h3 {
  margin: 0 0 6px 0;
}
.memo {
  margin-top: 6px;
  font-size: 0.9em;
  color: #333;
}
.controls {
  margin-bottom: 10px;
}
</style>
</head>
<body>

<h2>AV Actress Rating</h2>

<div class="controls">
  並び替え：
  <select id="sortKey">
    <option value="total">総合値</option>
    <option value="vision">視界制圧力</option>
    <option value="mental">心理的引力</option>
    <option value="erotic">煽情恒常力</option>
  </select>
  <button onclick="render()">反映</button>
</div>

<div>
  <h3>女優追加／編集</h3>
  名前 <input id="name">
  視界制圧力 <input id="vision" type="number" min="0" max="100">
  心理的引力 <input id="mental" type="number" min="0" max="100">
  煽情恒常力 <input id="erotic" type="number" min="0" max="100"><br>
  メモ<br>
  <textarea id="memo" rows="2" cols="40"></textarea><br>
  <button onclick="save()">保存</button>
</div>

<h3>CSV入力</h3>
<textarea id="csvInput" rows="5" cols="80"></textarea><br>
<button onclick="importCSV()">読み込み</button>
<button onclick="exportCSV()">CSV出力</button>

<hr>

<div id="list"></div>

<script>
let data = JSON.parse(localStorage.getItem("actressData") || "[]");

function save() {
  const name = document.getElementById("name").value;
  const obj = {
    name,
    vision: Number(document.getElementById("vision").value),
    mental: Number(document.getElementById("mental").value),
    erotic: Number(document.getElementById("erotic").value),
    memo: document.getElementById("memo").value
  };
  const idx = data.findIndex(d => d.name === name);
  if (idx >= 0) data[idx] = obj;
  else data.push(obj);
  persist();
  clearForm();
  render();
}

function clearForm() {
  ["name","vision","mental","erotic","memo"].forEach(id => {
    document.getElementById(id).value = "";
  });
}

function persist() {
  localStorage.setItem("actressData", JSON.stringify(data));
}

function total(d) {
  return d.vision + d.mental + d.erotic;
}

function render() {
  const key = document.getElementById("sortKey").value;
  let sorted = [...data];
  sorted.sort((a,b) => {
    if (key === "vision") return b.vision - a.vision;
    if (key === "mental") return b.mental - a.mental;
    if (key === "erotic") return b.erotic - a.erotic;
    return total(b) - total(a);
  });

  const list = document.getElementById("list");
  list.innerHTML = "";

  sorted.forEach(d => {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <h3>${d.name}</h3>
      視界制圧力: ${d.vision}<br>
      心理的引力: ${d.mental}<br>
      煽情恒常力: ${d.erotic}<br>
      <div class="memo">${d.memo || ""}</div>
      <button onclick="edit('${d.name}')">編集</button>
      <button onclick="showChart('${d.name}')">レーダー</button>
    `;
    list.appendChild(div);
  });
}

function edit(name) {
  const d = data.find(x => x.name === name);
  if (!d) return;
  document.getElementById("name").value = d.name;
  document.getElementById("vision").value = d.vision;
  document.getElementById("mental").value = d.mental;
  document.getElementById("erotic").value = d.erotic;
  document.getElementById("memo").value = d.memo;
}

function showChart(name) {
  const d = data.find(x => x.name === name);
  if (!d) return;
  const w = window.open("", "_blank");
  w.document.write(`
    <canvas id="c" width="400" height="400"></canvas>
    <div>
      視界制圧力: ${d.vision}<br>
      心理的引力: ${d.mental}<br>
      煽情恒常力: ${d.erotic}
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script>
    <script>
      new Chart(document.getElementById("c"), {
        type: "radar",
        data: {
          labels: ["視界制圧力","心理的引力","煽情恒常力"],
          datasets: [{
            data: [${d.vision},${d.mental},${d.erotic}],
            fill: true
          }]
        },
        options: {
          scales: {
            r: {
              min: 0,
              max: 100
            }
          }
        }
      });
    <\/script>
  `);
}

function importCSV() {
  const lines = document.getElementById("csvInput").value.trim().split("\n");
  data = lines.slice(1).map(l => {
    const [name,vision,mental,erotic,memo] = l.split(",");
    return {
      name,
      vision:Number(vision),
      mental:Number(mental),
      erotic:Number(erotic),
      memo:memo || ""
    };
  });
  persist();
  render();
}

function exportCSV() {
  let csv = "名前,視界制圧力,心理的引力,煽情恒常力,メモ\n";
  data.forEach(d => {
    csv += `${d.name},${d.vision},${d.mental},${d.erotic},${d.memo}\n`;
  });
  alert(csv);
}

render();
</script>

</body>
</html>
